# Testing Guide

This guide covers the testing infrastructure and processes for the Financial Transaction Tracker.

## Mock Data Generation

### Setup

```bash
# Install test dependencies
pip install -r requirements-test.txt

# Generate mock templates (replace with your values)
python scripts/generate_mock_template_messages.py \
    --email your.email@example.com \
    --start-date 2024-01-01
```

Required parameters:
- `--email`: Email address configured in your config.yaml under auth.gmail.email_to_account

Optional parameters:
- `--start-date`: Start date to search for transaction emails (format: YYYY-MM-DD)
  - If not provided, uses current date
  - Script will search up to 10 weeks back from the start date

The script will:
1. Search for transaction emails from the start date
2. Generate examples for each template type
3. Create mock_messages.py with successful matches
4. Create mock_messages_failures.py with failed matches (if any)

### Mock Templates
Located in `src/mock/api/mock_messages.py`, these templates provide:
- Standard transaction formats
- Edge cases
- Error scenarios
- Different financial institutions

> **Note**: The mock message files (`mock_messages.py` and `mock_messages_failures.py`) are generated files and should not be committed to version control. They are automatically generated by `generate_mock_template_messages.py` and contain synthetic transaction data based on real email templates. Run the generation script with your account details to create these files locally.

## Running Tests

### Unit Tests
```bash
# Run all tests
python -m pytest tests/

# Run specific test file
python -m pytest tests/test_transaction_parse.py

# Run with coverage
python -m pytest --cov=src tests/
```

### Template Tests
```bash
# Test template parsing
python -m pytest tests/test_transaction_parse.py

# Test email API ID functionality
python -m pytest tests/test_email_api_id.py
```

## Test Infrastructure

### Test Credentials
- Located in `credentials/` directory
- Most tests use mock credentials automatically
- Real credentials (optional):
  - Only needed for Gmail API integration tests
  - Configure in config.yaml under auth.gmail.accounts
  - Must be valid OAuth2 credentials with Gmail API access

### Mock API Responses
- Standard responses in `mock_messages.py`
- Error cases in `mock_messages_failures.py`
- Custom response generation utilities

### Template Testing
- Validation of parsing rules
- Field extraction verification
- Error handling scenarios
- Edge case coverage

### Email API ID Testing
- Unique ID generation
- Duplicate detection
- Cross-reference validation
- History tracking

## Continuous Integration

### Pre-commit Checks
```bash
# Install pre-commit hooks
pre-commit install

# Run manually
pre-commit run --all-files
```

### CI Pipeline
- Automated test execution
- Coverage reporting
- Template validation
- Mock data verification

## Troubleshooting

### Common Issues
1. Template parsing failures
   - Check template format
   - Verify test data
   - Review parsing rules

2. API ID conflicts
   - Clear test database
   - Reset mock data
   - Check ID generation

3. Mock data generation
   - Update template files
   - Check dependencies
   - Verify credentials

### Logging
```bash
# View test logs
cat template_test_log_results.log

# View specific test run
cat template_test_log_166b78f9793854a6_Chase_Credit_Cards_-_QQ.log
```

## Best Practices

1. **Template Creation**
   - Follow naming conventions
   - Include all required fields
   - Document special cases
   - Add validation rules

2. **Mock Data**
   - Use realistic values
   - Cover edge cases
   - Include failure scenarios
   - Document assumptions

3. **Test Writing**
   - One assertion per test
   - Clear test names
   - Comprehensive coverage
   - Clean test data

4. **Maintenance**
   - Regular template updates
   - Mock data refresh
   - Coverage monitoring
   - Documentation updates
``` 